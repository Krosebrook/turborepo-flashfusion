name: Dependency Management

on:
  schedule:
    - cron: '0 9 * * MON'  # Every Monday at 9 AM UTC
  workflow_dispatch:
    inputs:
      update-type:
        description: 'Type of update to perform'
        required: true
        type: choice
        options:
          - security
          - patch
          - minor
          - major
          - all

jobs:
  # Security Updates (High Priority)
  security-updates:
    name: Security Vulnerability Updates
    runs-on: ubuntu-latest
    if: github.event.inputs.update-type == 'security' || github.event.inputs.update-type == 'all' || github.event_name == 'schedule'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check for security vulnerabilities
        id: security-check
        run: |
          npm audit --audit-level=moderate --json > audit-results.json || true

          # Count vulnerabilities
          CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit-results.json)
          HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit-results.json)
          MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' audit-results.json)

          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "moderate=$MODERATE" >> $GITHUB_OUTPUT

          TOTAL=$((CRITICAL + HIGH + MODERATE))
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      - name: Apply security fixes
        if: steps.security-check.outputs.total > 0
        run: |
          echo "Found ${{ steps.security-check.outputs.total }} security vulnerabilities"
          echo "Critical: ${{ steps.security-check.outputs.critical }}"
          echo "High: ${{ steps.security-check.outputs.high }}"
          echo "Moderate: ${{ steps.security-check.outputs.moderate }}"

          # Try automatic fixes first
          npm audit fix --force || true

          # Generate report
          npm audit --audit-level=moderate > security-report.txt || true

      - name: Create security update PR
        if: steps.security-check.outputs.total > 0
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            security: fix vulnerabilities

            - Critical: ${{ steps.security-check.outputs.critical }}
            - High: ${{ steps.security-check.outputs.high }}
            - Moderate: ${{ steps.security-check.outputs.moderate }}

            Auto-generated by GitHub Actions
          title: "ðŸ”’ Security: Fix vulnerabilities in dependencies"
          body: |
            ## Security Update

            This PR contains automatic security fixes for dependencies.

            ### Vulnerabilities Fixed
            - **Critical**: ${{ steps.security-check.outputs.critical }}
            - **High**: ${{ steps.security-check.outputs.high }}
            - **Moderate**: ${{ steps.security-check.outputs.moderate }}

            ### What's Changed
            - Applied `npm audit fix` to resolve known vulnerabilities
            - Updated vulnerable packages to secure versions

            ### Testing
            - [ ] All CI checks pass
            - [ ] Application builds successfully
            - [ ] No functionality regression

            **Auto-generated by GitHub Actions**
          branch: security/dependency-updates
          delete-branch: true
          labels: |
            security
            dependencies
            automated

  # Regular Dependency Updates
  dependency-updates:
    name: Regular Dependency Updates
    runs-on: ubuntu-latest
    if: github.event.inputs.update-type != 'security'
    strategy:
      matrix:
        update-type: [patch, minor, major]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install npm-check-updates
        run: npm install -g npm-check-updates

      - name: Check for updates
        id: check-updates
        run: |
          case "${{ matrix.update-type }}" in
            patch)
              ncu --target patch --jsonAll > updates-patch.json
              UPDATES=$(ncu --target patch --jsonAll | jq -r 'keys | length')
              ;;
            minor)
              ncu --target minor --jsonAll > updates-minor.json
              UPDATES=$(ncu --target minor --jsonAll | jq -r 'keys | length')
              ;;
            major)
              ncu --target latest --jsonAll > updates-major.json
              UPDATES=$(ncu --target latest --jsonAll | jq -r 'keys | length')
              ;;
          esac

          echo "updates=$UPDATES" >> $GITHUB_OUTPUT

      - name: Apply updates
        if: steps.check-updates.outputs.updates > 0
        run: |
          case "${{ matrix.update-type }}" in
            patch)
              ncu --target patch -u
              ;;
            minor)
              ncu --target minor -u
              ;;
            major)
              ncu --target latest -u
              ;;
          esac

          npm install

      - name: Run tests after update
        if: steps.check-updates.outputs.updates > 0
        run: |
          npm test || echo "Tests failed - this will be noted in the PR"
          npm run build || echo "Build failed - this will be noted in the PR"

      - name: Create update PR
        if: steps.check-updates.outputs.updates > 0
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            deps: update ${{ matrix.update-type }} dependencies

            Updated ${{ steps.check-updates.outputs.updates }} packages

            Auto-generated by GitHub Actions
          title: "â¬†ï¸ Update ${{ matrix.update-type }} dependencies"
          body: |
            ## Dependency Updates (${{ matrix.update-type }})

            This PR updates ${{ steps.check-updates.outputs.updates }} packages to their latest ${{ matrix.update-type }} versions.

            ### Package Updates
            ```json
            $(cat updates-${{ matrix.update-type }}.json 2>/dev/null || echo "{}")
            ```

            ### Checklist
            - [ ] All tests pass
            - [ ] Application builds successfully
            - [ ] No breaking changes introduced
            - [ ] Documentation updated if needed

            **Auto-generated by GitHub Actions**
          branch: deps/${{ matrix.update-type }}-updates
          delete-branch: true
          labels: |
            dependencies
            ${{ matrix.update-type }}
            automated

  # License Compliance Check
  license-compliance:
    name: License Compliance Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Check licenses
        run: |
          npx license-checker --summary --onlyAllow "MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;CC0-1.0;Unlicense" > license-report.txt 2>&1 || true

          # Check for problematic licenses
          npx license-checker --excludePrivatePackages --failOn "GPL;AGPL;LGPL;CPAL;OSL;EPL;MPL" 2>&1 | tee license-violations.txt || true

      - name: Upload license reports
        uses: actions/upload-artifact@v3
        with:
          name: license-reports
          path: |
            license-report.txt
            license-violations.txt

      - name: Comment on violations
        if: failure()
        run: |
          echo "## License Compliance Issues Found" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat license-violations.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # Dependency Health Check
  dependency-health:
    name: Dependency Health Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Analyze dependency health
        run: |
          echo "# Dependency Health Report" > health-report.md
          echo "Date: $(date)" >> health-report.md
          echo "" >> health-report.md

          # Check for outdated packages
          echo "## Outdated Packages" >> health-report.md
          npm outdated --json > outdated.json 2>/dev/null || echo "{}" > outdated.json

          # Count outdated packages
          OUTDATED_COUNT=$(jq 'keys | length' outdated.json)
          echo "Total outdated packages: $OUTDATED_COUNT" >> health-report.md
          echo "" >> health-report.md

          # Check bundle size impact
          echo "## Bundle Size Analysis" >> health-report.md
          npx webpack-bundle-analyzer --help > /dev/null 2>&1 && echo "Webpack bundle analyzer available" >> health-report.md || echo "No bundle analyzer configured" >> health-report.md

          # Check for unused dependencies
          echo "## Unused Dependencies" >> health-report.md
          npx depcheck --json > depcheck.json 2>/dev/null || echo "{}" > depcheck.json
          UNUSED_COUNT=$(jq '.dependencies | length' depcheck.json)
          echo "Potentially unused dependencies: $UNUSED_COUNT" >> health-report.md

          cat health-report.md >> $GITHUB_STEP_SUMMARY

      - name: Upload health report
        uses: actions/upload-artifact@v3
        with:
          name: dependency-health
          path: |
            health-report.md
            outdated.json
            depcheck.json

  # Cleanup old branches
  cleanup-branches:
    name: Cleanup Old Dependency Branches
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Delete old dependency branches
        run: |
          # Delete merged dependency branches older than 30 days
          git for-each-ref --format='%(refname:short) %(committerdate:iso8601)' refs/remotes/origin | \
          grep -E "(deps/|security/)" | \
          while read branch date; do
            branch_name=${branch#origin/}
            if [[ $(date -d "$date" +%s) -lt $(date -d "30 days ago" +%s) ]]; then
              echo "Deleting old branch: $branch_name"
              git push origin --delete "$branch_name" || echo "Branch already deleted or protected"
            fi
          done

  # Summary Report
  summary:
    name: Dependency Management Summary
    needs: [security-updates, dependency-updates, license-compliance, dependency-health]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# Dependency Management Summary" >> $GITHUB_STEP_SUMMARY
          echo "Date: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Security Updates | ${{ needs.security-updates.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Updates | ${{ needs.dependency-updates.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Compliance | ${{ needs.license-compliance.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Health Analysis | ${{ needs.dependency-health.result }} |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review any created pull requests" >> $GITHUB_STEP_SUMMARY
          echo "2. Test updated dependencies thoroughly" >> $GITHUB_STEP_SUMMARY
          echo "3. Address any license compliance issues" >> $GITHUB_STEP_SUMMARY
          echo "4. Monitor for new security advisories" >> $GITHUB_STEP_SUMMARY